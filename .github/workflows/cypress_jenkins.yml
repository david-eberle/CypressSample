name: Jenkins job

on:
  workflow_dispatch:
  schedule:
    - cron: '0 13 * * *'

jobs:
  saucedemo_login:
    name: Saucedemo Login Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run Cypress saucedemo tests
        run: |
          mkdir -p cypress/results
          echo "==> Running saucedemo login test..."
          docker run --rm -t \
            -v ${{ github.workspace }}:/e2e \
            -w /e2e \
            cypress/included:12.17.0 \
            npx cypress run \
              --spec "cypress/e2e/saucedemo/login.cy.js" \
              --reporter json \
              --reporter-options output=cypress/results/saucedemo-login.json \
              --browser chrome

      - name: Upload saucedemo result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: saucedemo-login-json
          path: cypress/results/saucedemo-login.json

  expandtesting_login:
    name: ExpandTesting Login Test
    runs-on: ubuntu-latest
    needs: [saucedemo_login]
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run Cypress expandtesting tests
        run: |
          mkdir -p cypress/results
          echo "==> Running expandtesting login test..."
          docker run --rm -t \
            -v ${{ github.workspace }}:/e2e \
            -w /e2e \
            cypress/included:12.17.0 \
            npx cypress run \
              --spec "cypress/e2e/expandtesting/login.cy.js" \
              --reporter json \
              --reporter-options output=cypress/results/expandtesting-login.json \
              --browser chrome

      - name: Upload expandtesting result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: expandtesting-login-json
          path: cypress/results/expandtesting-login.json

  expandtesting_webpark:
    name: ExpandTesting Webpark
    runs-on: ubuntu-latest
    needs: [expandtesting_login]
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run Cypress expandtesting tests
        run: |
          mkdir -p cypress/results
          echo "==> Running expandtesting webpark test..."
          docker run --rm -t \
            -v ${{ github.workspace }}:/e2e \
            -w /e2e \
            cypress/included:12.17.0 \
            npx cypress run \
              --spec "cypress/e2e/expandtesting/webpark.cy.js" \
              --reporter json \
              --reporter-options output=cypress/results/expandtesting-webpark.json \
              --browser chrome

      - name: Upload expandtesting result
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: expandtesting_webpark-json
          path: cypress/results/expandtesting-webpark.json

  notify_testhub:
    name: Post results to TestHub
    runs-on: ubuntu-latest
    if: always()
    needs: [
      saucedemo_login,
      expandtesting_login,
      expandtesting_webpark
    ]
    env:
      TESTHUB_TOKEN: ${{ secrets.TESTHUB_TOKEN }}
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./cypress/results

      - name: Flatten JSON files
        run: |
          find cypress/results -mindepth 2 -type f -name '*.json' -exec mv {} cypress/results/ \;

      - name: Build payload and post
        run: |
          JOB_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          RESULTS_JSON="[]"
          for file in cypress/results/*.json; do
            TEST_NAME=$(jq -r '.testName' $file)
            DURATION=$(jq -r '.durationMs' $file)
            PASSED=$(jq -r '.passed' $file)
            RESULTS_JSON=$(echo $RESULTS_JSON | jq --arg name "$TEST_NAME" --argjson duration "$DURATION" --argjson passed "$PASSED" '. + [{name: $name, passed: $passed, duration: $duration, logUrl: "'"$JOB_URL"'"}]')
          done
          PAYLOAD=$(jq -n \
            --arg projectName "ExpandTesting" \
            --arg source "Jenkins" \
            --arg triggeredBy "qat-ci-bot" \
            --argjson results "$RESULTS_JSON" \
            '{
              projectName: $projectName,
              source: $source,
              triggeredBy: $triggeredBy,
              results: $results
            }'
          )
          echo "Posting results..."
          curl -X POST https://testhub-server.azurewebsites.net/api/testruns \
            -H "Content-Type: application/json" \
            -H "X-Auth-Token: $TESTHUB_TOKEN" \
            -d "$PAYLOAD"
