name: Cypress E2E Tests

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  saucedemo_login:
    name: Saucedemo Login Test
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run Cypress saucedemo tests
        continue-on-error: true
        run: |
          mkdir -p cypress/results
          echo "==> Running saucedemo login test..."
          docker run --rm -t \
            -v ${{ github.workspace }}:/e2e \
            -w /e2e \
            cypress/included:12.17.0 \
            npx cypress run \
              --spec "cypress/e2e/saucedemo/login.cy.js" \
              --reporter json \
              --reporter-options output=cypress/results/saucedemo-login.json \
              --browser chrome

      - name: Upload saucedemo result
        uses: actions/upload-artifact@v4
        with:
          name: saucedemo-login-json
          path: cypress/results/saucedemo-login.json

  expandtesting_login:
    name: ExpandTesting Login Test
    runs-on: ubuntu-latest
    needs: [saucedemo_login]
    continue-on-error: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run Cypress expandtesting tests
        continue-on-error: true
        run: |
          mkdir -p cypress/results
          echo "==> Running expandtesting login test..."
          docker run --rm -t \
            -v ${{ github.workspace }}:/e2e \
            -w /e2e \
            cypress/included:12.17.0 \
            npx cypress run \
              --spec "cypress/e2e/expandtesting/login.cy.js" \
              --reporter json \
              --reporter-options output=cypress/results/expandtesting-login.json \
              --browser chrome

      - name: Upload expandtesting result
        uses: actions/upload-artifact@v4
        with:
          name: expandtesting-login-json
          path: cypress/results/expandtesting-login.json

  expandtesting_webpark:
    name: ExpandTesting Webpark
    runs-on: ubuntu-latest
    needs: [expandtesting_login]
    continue-on-error: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run Cypress expandtesting tests
        continue-on-error: true
        run: |
          mkdir -p cypress/results
          echo "==> Running expandtesting webpark test..."
          docker run --rm -t \
            -v ${{ github.workspace }}:/e2e \
            -w /e2e \
            cypress/included:12.17.0 \
            npx cypress run \
              --spec "cypress/e2e/expandtesting/webpark.cy.js" \
              --reporter json \
              --reporter-options output=cypress/results/expandtesting-webpark.json \
              --browser chrome

      - name: Upload expandtesting result
        uses: actions/upload-artifact@v4
        with:
          name: expandtesting_webpark-json
          path: cypress/results/expandtesting-webpark.json

  expandtesting_draganddrop:
    name: ExpandTesting Drag and Drop
    runs-on: ubuntu-latest
    needs: [expandtesting_webpark]
    continue-on-error: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run Cypress drag and drop tests
        continue-on-error: true
        run: |
          mkdir -p cypress/results
          echo "==> Running expandtesting drag and drop test..."
          docker run --rm -t \
            -v ${{ github.workspace }}:/e2e \
            -w /e2e \
            cypress/included:12.17.0 \
            npx cypress run \
              --spec "cypress/e2e/expandtesting/draganddrop.cy.js" \
              --reporter json \
              --reporter-options output=cypress/results/expandtesting-draganddrop.json \
              --browser chrome

      - name: Upload drag and drop result
        uses: actions/upload-artifact@v4
        with:
          name: expandtesting-draganddrop-json
          path: cypress/results/expandtesting-draganddrop.json

  expandtesting_typo:
    name: ExpandTesting Typo
    runs-on: ubuntu-latest
    needs: [expandtesting_draganddrop]
    continue-on-error: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run Cypress typo tests
        continue-on-error: true
        run: |
          mkdir -p cypress/results
          echo "==> Running expandtesting typo test..."
          docker run --rm -t \
            -v ${{ github.workspace }}:/e2e \
            -w /e2e \
            cypress/included:12.17.0 \
            npx cypress run \
              --spec "cypress/e2e/expandtesting/typo.cy.js" \
              --reporter json \
              --reporter-options output=cypress/results/expandtesting-typo.json \
              --browser chrome

      - name: Upload typo result
        uses: actions/upload-artifact@v4
        with:
          name: expandtesting-typo-json
          path: cypress/results/expandtesting-typo.json

  expandtesting_upload:
    name: ExpandTesting Upload
    runs-on: ubuntu-latest
    needs: [expandtesting_typo]
    continue-on-error: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run Cypress upload tests
        continue-on-error: true
        run: |
          mkdir -p cypress/results
          echo "==> Running expandtesting upload test..."
          docker run --rm -t \
            -v ${{ github.workspace }}:/e2e \
            -w /e2e \
            cypress/included:12.17.0 \
            npx cypress run \
              --spec "cypress/e2e/expandtesting/upload.cy.js" \
              --reporter json \
              --reporter-options output=cypress/results/expandtesting-upload.json \
              --browser chrome

      - name: Upload upload result
        uses: actions/upload-artifact@v4
        with:
          name: expandtesting-upload-json
          path: cypress/results/expandtesting-upload.json

  notify_testhub:
    name: Post results to TestHub
    runs-on: ubuntu-latest
    needs: [saucedemo_login, expandtesting_login, expandtesting_webpark, expandtesting_draganddrop, expandtesting_typo, expandtesting_upload]
    env:
      TESTHUB_TOKEN: ${{ secrets.TESTHUB_TOKEN }}
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./cypress/results

      - name: Flatten JSON files
        run: |
          find cypress/results -mindepth 2 -type f -name '*.json' -exec mv {} cypress/results/ \;

      - name: Build payload and post
        run: |
          JOB_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          RESULTS_JSON="[]"
          for file in cypress/results/*.json; do
            TEST_NAME=$(jq -r '.testName' $file)
            DURATION=$(jq -r '.durationMs' $file)
            if jq -e '.stats.failures' $file > /dev/null 2>&1; then
              PASSED=$(jq -r '.stats.failures == 0' $file)
            else
              PASSED=true
            fi
            RESULTS_JSON=$(echo $RESULTS_JSON | jq --arg name "$TEST_NAME" --argjson duration "$DURATION" --argjson passed "$PASSED" '. + [{name: $name, passed: $passed, duration: $duration, logUrl: "'"$JOB_URL"'"}]')
          done
          PAYLOAD=$(jq -n \
            --arg projectName "ExpandTesting" \
            --arg source "GitHub Actions" \
            --arg triggeredBy "qat-ci-bot" \
            --argjson results "$RESULTS_JSON" \
            '{
              projectName: $projectName,
              source: $source,
              triggeredBy: $triggeredBy,
              results: $results
            }'
          )
          echo "Posting results..."
          curl -X POST https://testhub-server.azurewebsites.net/api/testruns \
            -H "Content-Type: application/json" \
            -H "X-Auth-Token: $TESTHUB_TOKEN" \
            -d "$PAYLOAD"
