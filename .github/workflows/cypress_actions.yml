name: Actions job

on:
  workflow_dispatch:
  schedule:
    - cron: '0 13 * * *'

jobs:
  expandtesting_draganddrop:
    name: ExpandTesting Drag and Drop
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run Cypress drag and drop tests
        run: |
          mkdir -p cypress/results
          echo "==> Running expandtesting drag and drop test..."
          docker run --rm -t \
            -v ${{ github.workspace }}:/e2e \
            -w /e2e \
            cypress/included:12.17.0 \
            npx cypress run \
              --spec "cypress/e2e/expandtesting/draganddrop.cy.js" \
              --reporter json \
              --reporter-options output=cypress/results/expandtesting-draganddrop.json \
              --browser chrome

      - name: Upload drag and drop result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: expandtesting-draganddrop-json
          path: cypress/results/expandtesting-draganddrop.json

  expandtesting_typo:
    name: ExpandTesting Typo
    runs-on: ubuntu-latest
    if: always()
    needs: [expandtesting_draganddrop]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run Cypress typo tests
        run: |
          mkdir -p cypress/results
          echo "==> Running expandtesting typo test..."
          docker run --rm -t \
            -v ${{ github.workspace }}:/e2e \
            -w /e2e \
            cypress/included:12.17.0 \
            npx cypress run \
              --spec "cypress/e2e/expandtesting/typo.cy.js" \
              --reporter json \
              --reporter-options output=cypress/results/expandtesting-typo.json \
              --browser chrome

      - name: Upload typo result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: expandtesting-typo-json
          path: cypress/results/expandtesting-typo.json

  expandtesting_upload:
    name: ExpandTesting Upload
    runs-on: ubuntu-latest
    if: always()
    needs: [expandtesting_typo]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run Cypress upload tests
        run: |
          mkdir -p cypress/results
          echo "==> Running expandtesting upload test..."
          docker run --rm -t \
            -v ${{ github.workspace }}:/e2e \
            -w /e2e \
            cypress/included:12.17.0 \
            npx cypress run \
              --spec "cypress/e2e/expandtesting/upload.cy.js" \
              --reporter json \
              --reporter-options output=cypress/results/expandtesting-upload.json \
              --browser chrome

      - name: Upload upload result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: expandtesting-upload-json
          path: cypress/results/expandtesting-upload.json

  expandtesting_dynamicpagination:
    name: ExpandTesting Dynamic Pagination
    runs-on: ubuntu-latest
    if: always()
    needs: [expandtesting_upload]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run Cypress pagination test
        run: |
          mkdir -p cypress/results
          echo "==> Running expandtesting dynamic pagination..."
          docker run --rm -t \
            -v ${{ github.workspace }}:/e2e \
            -w /e2e \
            cypress/included:12.17.0 \
            npx cypress run \
              --spec "cypress/e2e/expandtesting/pagination.cy.js" \
              --reporter json \
              --reporter-options output=cypress/results/expandtesting-pagination.json \
              --browser chrome

      - name: Upload pagination result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: expandtesting-pagination-json
          path: cypress/results/expandtesting-pagination.json

  expandtesting_notification:
    name: ExpandTesting Notification
    runs-on: ubuntu-latest
    if: always()
    needs: [expandtesting_dynamicpagination]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run Cypress notification test
        run: |
          mkdir -p cypress/results
          echo "==> Running expandtesting notification..."
          docker run --rm -t \
            -v ${{ github.workspace }}:/e2e \
            -w /e2e \
            cypress/included:12.17.0 \
            npx cypress run \
              --spec "cypress/e2e/expandtesting/notification.cy.js" \
              --reporter json \
              --reporter-options output=cypress/results/expandtesting-notification.json \
              --browser chrome

      - name: Upload notification result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: expandtesting-notification-json
          path: cypress/results/expandtesting-notification.json

  expandtesting_formvalidation:
    name: ExpandTesting Form Validation
    runs-on: ubuntu-latest
    if: always()
    needs: [expandtesting_notification]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run Cypress form validation test
        run: |
          mkdir -p cypress/results
          echo "==> Running expandtesting form validation..."
          docker run --rm -t \
            -v ${{ github.workspace }}:/e2e \
            -w /e2e \
            cypress/included:12.17.0 \
            npx cypress run \
              --spec "cypress/e2e/expandtesting/validation.cy.js" \
              --reporter json \
              --reporter-options output=cypress/results/expandtesting-formvalidation.json \
              --browser chrome

      - name: Upload form validation result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: expandtesting-formvalidation-json
          path: cypress/results/expandtesting-formvalidation.json

  expandtesting_autocomplete:
    name: ExpandTesting Autocomplete
    runs-on: ubuntu-latest
    if: always()
    needs: [expandtesting_formvalidation]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run Cypress autocomplete test
        run: |
          mkdir -p cypress/results
          echo "==> Running expandtesting autocomplete..."
          docker run --rm -t \
            -v ${{ github.workspace }}:/e2e \
            -w /e2e \
            cypress/included:12.17.0 \
            npx cypress run \
              --spec "cypress/e2e/expandtesting/autocomplete.cy.js" \
              --reporter json \
              --reporter-options output=cypress/results/expandtesting-autocomplete.json \
              --browser chrome

      - name: Upload autocomplete result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: expandtesting-autocomplete-json
          path: cypress/results/expandtesting-autocomplete.json

  notify_testhub:
    name: Post results to TestHub
    if: always()
    runs-on: ubuntu-latest
    needs: [
      expandtesting_draganddrop,
      expandtesting_typo,
      expandtesting_upload,
      expandtesting_dynamicpagination,
      expandtesting_notification,
      expandtesting_formvalidation,
      expandtesting_autocomplete
    ]
    env:
      TESTHUB_TOKEN: ${{ secrets.TESTHUB_TOKEN }}
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./cypress/results

      - name: Flatten JSON files
        run: |
          find cypress/results -mindepth 2 -type f -name '*.json' -exec mv {} cypress/results/ \;

      - name: Build payload and post
        run: |
          JOB_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          RESULTS_JSON="[]"
          for file in cypress/results/*.json; do
            TEST_NAME=$(jq -r '.testName' $file)
            DURATION=$(jq -r '.durationMs' $file)
            ERROR_MSG=$(jq -r '.firstErrorMessage' $file)
            PASSED=$(jq -r '.passed' $file)
            RESULTS_JSON=$(echo $RESULTS_JSON | jq --arg name "$TEST_NAME" --argjson duration "$DURATION" --argjson passed "$PASSED"  --argjson errormsg "$ERROR_MSG" '. + [{name: $name, passed: $passed, duration: $duration, errormsg: $errormsg, logUrl: "'"$JOB_URL"'"}]')
          done
          PAYLOAD=$(jq -n \
            --arg projectName "ExpandTesting" \
            --arg source "GitHub Actions" \
            --arg triggeredBy "qat-ci-bot" \
            --argjson results "$RESULTS_JSON" \
            '{
              projectName: $projectName,
              source: $source,
              triggeredBy: $triggeredBy,
              results: $results
            }'
          )
          echo "Posting results..."
          curl -X POST https://testhub-server.azurewebsites.net/api/testruns \
            -H "Content-Type: application/json" \
            -H "X-Auth-Token: $TESTHUB_TOKEN" \
            -d "$PAYLOAD"
