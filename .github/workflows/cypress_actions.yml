name: Cypress E2E Tests

on:
  push:
    branches: [main]
  workflow_dispatch:
  
jobs:
  saucedemo_login:
    name: Saucedemo Login Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run Cypress saucedemo tests
        run: |
          mkdir -p cypress/results
          docker run --rm \
            -v ${{ github.workspace }}:/e2e \
            -w /e2e \
            cypress/included:12.17.0 \
            npx cypress run --spec "cypress/e2e/saucedemo/**/*.cy.js" --reporter json --reporter-options output=cypress/results/saucedemo.json || true

      - name: Upload saucedemo result
        uses: actions/upload-artifact@v4
        with:
          name: saucedemo-json
          path: cypress/results/saucedemo-login.json

  expandtesting_login:
    name: ExpandTesting Login Test
    runs-on: ubuntu-latest
    needs: [saucedemo_login]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run Cypress expandtesting tests
        run: |
          mkdir -p cypress/results
          docker run --rm \
            -v ${{ github.workspace }}:/e2e \
            -w /e2e \
            cypress/included:12.17.0 \
            npx cypress run --spec "cypress/e2e/expandtesting/**/*.cy.js" --reporter json --reporter-options output=cypress/results/expandtesting.json || true

      - name: Upload expandtesting result
        uses: actions/upload-artifact@v4
        with:
          name: expandtesting-json
          path: cypress/results/expandtesting-login.json

  notify_testhub:
    name: Post results to TestHub
    runs-on: ubuntu-latest
    needs: [saucedemo_login, expandtesting_login]
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./cypress/results

      - name: Flatten JSON files
        run: |
          find cypress/results -mindepth 2 -type f -name '*.json' -exec mv {} cypress/results/ \;

      - name: Build payload and post
        run: |
          JOB_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          RESULTS_JSON="[]"

          for file in cypress/results/*.json; do
            TEST_NAME=$(jq -r '.testName' $file)
            DURATION=$(jq -r '.durationMs' $file)
            # asumimos que si el JSON no tiene stats.failures, lo marcamos como passed
            if jq -e '.stats.failures' $file > /dev/null 2>&1; then
              PASSED=$(jq -r '.stats.failures == 0' $file)
            else
              PASSED=true
            fi

            RESULTS_JSON=$(echo $RESULTS_JSON | jq --arg name "$TEST_NAME" --argjson duration "$DURATION" --argjson passed "$PASSED" '. + [{name: $name, passed: $passed, duration: $duration, logUrl: "'"$JOB_URL"'"}]')
          done

          PAYLOAD=$(jq -n \
            --arg projectName "Cypress Tests" \
            --arg source "GitHub Actions" \
            --arg triggeredBy "qat-ci-bot" \
            --argjson results "$RESULTS_JSON" \
            '{
              projectName: $projectName,
              source: $source,
              triggeredBy: $triggeredBy,
              results: $results
            }'
          )

          echo "Posting results:"
          echo "$PAYLOAD"

          curl -X POST https://testhub-server.azurewebsites.net/api/testruns \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"
