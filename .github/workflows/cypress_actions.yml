name: Cypress Tests

on:
  push:
    branches: [main]
  pull_request:

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Install Cypress
        run: npx cypress install

      - name: Run Cypress tests
        id: cypress
        run: npx cypress run --spec "cypress/e2e/saucedemo/**/*.cy.js"

      - name: Read test results
        run: |
          RESULTS_FILE="cypress/results/login-test.json"
          if [ -f "$RESULTS_FILE" ]; then
            TEST_NAME=$(jq -r '.testName' $RESULTS_FILE)
            DURATION=$(jq -r '.durationMs' $RESULTS_FILE)
            if [ "${{ job.status }}" == "success" ]; then
              STATUS="passed"
            else
              STATUS="failed"
            fi
            echo "Test: $TEST_NAME"
            echo "Duration (ms): $DURATION"
            echo "Status: $STATUS"
          else
            echo "Results file not found"
          fi
